name: Run WWW/TLS Fix on Kopa Mkopa EC2

on:
  workflow_dispatch: {}

jobs:
  run-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Copy fix script to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          source: "tools/fix_mkopaji_www_tls_noninteractive.sh"
          target: "/tmp/fix_kopa_mkopaji_www_tls_noninteractive.sh"

      - name: Set execute and run script via SSH
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            sudo mv /tmp/fix_kopa_mkopaji_www_tls_noninteractive.sh /usr/local/bin/fix_kopa_mkopaji_www_tls_noninteractive.sh
            sudo chmod +x /usr/local/bin/fix_kopa_mkopaji_www_tls_noninteractive.sh
            sudo /usr/local/bin/fix_kopa_mkopaji_www_tls_noninteractive.sh

      - name: Force Deploy Kopa Mkopa App
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            sudo chmod +x /var/www/html/kopa-mkopaji/tools/deploy_kopa_mkopaji.sh
            sudo /var/www/html/kopa-mkopaji/tools/deploy_kopa_mkopaji.sh

      - name: Fetch verification from public site
        run: |
          echo "Fetching https://kopa.mkopaji.com/ to confirm headers"
          curl -I https://kopa.mkopaji.com/ || true

# IMPORTANT: Add repository secrets: EC2_HOST, EC2_USERNAME, EC2_SSH_PRIVATE_KEY (private key contents)
#
# To add these secrets:
# 1. Go to your repository on GitHub.
# 2. Click on 'Settings' > 'Secrets and variables' > 'Actions'.
# 3. Click 'New repository secret'.
# 4. Add the following secrets:
#    - EC2_HOST: Your server's public IP or DNS (e.g., 69.169.97.136 or ec2-xx-xx-xx-xx.compute-1.amazonaws.com)
#    - EC2_USERNAME: The SSH username (e.g., ubuntu, ec2-user, or root)
#    - EC2_SSH_PRIVATE_KEY: The contents of your private SSH key (start with '-----BEGIN OPENSSH PRIVATE KEY-----')
#
# Without these, the workflow cannot connect to your server securely.
